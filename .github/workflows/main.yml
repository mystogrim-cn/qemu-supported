name: Persistent Ubuntu VPS (5h30 Auto-Restart)

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 335  # 5h30m + buffer

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0
          lfs: true

      - name: Prepare vm_data folder
        run: |
          echo "📁 Preparing vm_data folder..."
          mkdir -p "$GITHUB_WORKSPACE/vm_data"
          echo "✅ vm_data folder ready."

      - name: Restore previous VM data (includes .qcow2/.raw/.iso/.img/.vmdk/.qwoc)
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "🔁 Restoring VM data from vm-data branch..."
          cd "$GITHUB_WORKSPACE/vm_data"
          rm -rf ./*
          git clone --quiet --branch vm-data "https://$PAT_TOKEN@github.com/${{ github.repository }}" . \
            || echo "⚠️ vm-data branch not found — starting fresh."
          echo "✅ Data restored (includes QEMU disks and ISOs)."
          ls -lh || true

      - name: Start SSHX (for remote access)
        run: |
          echo "⚙️ Starting SSHX..."
          cd "$GITHUB_WORKSPACE/vm_data"
          nohup bash -c "curl -sSf https://sshx.io/get | sh -s run > sshx_link.txt 2>&1" &
          sleep 8
          echo "🌐 SSHX Link:"
          grep -Eo 'https://sshx.io/[^ ]+' sshx_link.txt || echo "❌ SSHX link not found"
          echo "✅ SSHX running."

      - name: Start Heartbeat & Autosave (Recursive LFS Scan)
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "💾 Starting autosave (10s interval, recursive scan)..."
          cd "$GITHUB_WORKSPACE/vm_data"

          # Install Git LFS
          sudo apt-get update -qq
          sudo apt-get install -y git-lfs
          git lfs install --skip-repo

          # Configure .gitattributes safely (no heredoc)
          {
            echo "*.qcow2 filter=lfs diff=lfs merge=lfs -text"
            echo "*.raw filter=lfs diff=lfs merge=lfs -text"
            echo "*.iso filter=lfs diff=lfs merge=lfs -text"
            echo "*.img filter=lfs diff=lfs merge=lfs -text"
            echo "*.vmdk filter=lfs diff=lfs merge=lfs -text"
            echo "*.qwoc filter=lfs diff=lfs merge=lfs -text"
          } > .gitattributes

          git add .gitattributes
          git commit -m "Enable Git LFS for VM files" -q || true
          git push -f "https://$PAT_TOKEN@github.com/${{ github.repository }}" HEAD:vm-data || true

          # Start autosave loop
          SLEEP_SECONDS=10
          nohup bash -c "
            while true; do
              echo '🔍 Scanning for VM image files...'
              find . -type f \( -iname '*.qcow2' -o -iname '*.raw' -o -iname '*.iso' -o -iname '*.img' -o -iname '*.vmdk' -o -iname '*.qwoc' \) -print || true

              git init -q || true
              git config user.email 'actions@github.com'
              git config user.name 'github-actions'
              git add --all || true
              git commit -m '🕐 Autosave at $(date "+%Y-%m-%d %H:%M:%S")' -q || true
              git branch -M vm-data || true
              git push -f 'https://$PAT_TOKEN@github.com/${{ github.repository }}' vm-data >/dev/null 2>&1 || true

              echo '[✅] Autosave complete at $(date "+%H:%M:%S")'
              sleep $SLEEP_SECONDS
            done
          " &
          echo "✅ Autosave loop started (interval: ${SLEEP_SECONDS}s)."

      - name: Keep VPS alive
        run: |
          echo "⏳ VPS running for 5 hours 30 minutes..."
          sleep 19800

      - name: Final Save + Auto Restart (LFS recursive backup)
        if: always()
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          WORKFLOW_FILE: main.yml
          RESTART_REF: main
        run: |
          echo "📦 Saving final data before restart..."
          cd "$GITHUB_WORKSPACE/vm_data"

          sudo apt-get update -qq
          sudo apt-get install -y git-lfs
          git lfs install --skip-repo

          {
            echo "*.qcow2 filter=lfs diff=lfs merge=lfs -text"
            echo "*.raw filter=lfs diff=lfs merge=lfs -text"
            echo "*.iso filter=lfs diff=lfs merge=lfs -text"
            echo "*.img filter=lfs diff=lfs merge=lfs -text"
            echo "*.vmdk filter=lfs diff=lfs merge=lfs -text"
            echo "*.qwoc filter=lfs diff=lfs merge=lfs -text"
          } > .gitattributes

          git add --all || true
          git commit -m "💾 Final autosave before restart $(date '+%Y-%m-%d %H:%M:%S')" -q || true
          git branch -M vm-data || true
          git push -f "https://$PAT_TOKEN@github.com/${{ github.repository }}" vm-data || true
          echo "✅ Final data saved (includes all VM images)."

          echo "♻️ Triggering automatic restart..."
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $PAT_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_FILE/dispatches" \
            -d "{\"ref\":\"$RESTART_REF\"}" >/dev/null 2>&1 || true
          echo "✅ Restart request sent!"
